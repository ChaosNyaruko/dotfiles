" modeline vim: fdm=marker 
" General settings {{{ 
set nocompatible 
filetype plugin indent on
set encoding=utf-8
set nu
set rnu
set hlsearch
set incsearch
set ignorecase
set smartcase
set mouse=a
set shiftwidth=4                " Use indents of 4 spaces
set expandtab                   " Tabs are spaces, not tabs
set tabstop=4                   " An indentation every four columns
set softtabstop=4               " Let backspace delete indent
set showmode
set wildmenu
set wildmode=list:longest,full " basically [:] means [&&]  [,] means [then]
" set wildoptions=pum,tagfile "nvim's default settings
" set colorcolumn=120 " a mark at col 120 indicating that the line is too long
set showtabline=1
set background=dark

set novisualbell
set noswapfile
set nobackup
set nowritebackup

set hidden
set history=2000
set splitright
let mapleader=" "
" set autochdir

set nolist
set listchars=tab:›\ ,trail:•,extends:#,nbsp:. " Highlight problematic whitespace
set backspace=indent,eol,start
colorscheme default

" Common mappings
" Visual shifting (does not exit Visual mode)
vnoremap < <gv
vnoremap > >gv
" vnoremap / y/<c-r>"
"
"MYVIMRC mappings
nnoremap <leader>sv :source $MYVIMRC<cr>
nnoremap <leader>ev :vsp $MYVIMRC<cr>

" something interesting saw in coding videos, but seems useful
autocmd InsertEnter * :set norelativenumber
autocmd InsertLeave * :set relativenumber
autocmd FileType qf :set norelativenumber
"}}}

" Share clipboard if possible"{{{
if has('clipboard') 
	if has('unnamedplus')  " When possible use + register for copy-paste
	    set clipboard=unnamed,unnamedplus
	else         " On mac and Windows, use * register for copy-paste
	    set clipboard=unnamed
    endif
endif "}}}

" Set a rough statusline "{{{
if has('statusline') 
    set laststatus=2

    " Broken down into easily includeable segments
    set shortmess-=S " display the number of matches from a search, see https://vi.stackexchange.com/questions/15944/how-to-display-in-the-statusline-the-number-of-matches-from-a-search
    set statusline=%<%f\                     " Filename
    set statusline+=%w%h%m%r                 " Options
    set statusline+=\ [%{&ff}/%Y/%{&fileencoding?&fileencoding:&encoding}]            " Filetype
    set statusline+=\ [%{getcwd()}]          " Current dir
    " set statusline+=\ %b\ 0x%B             " ga/:ascii 
    set statusline+=%=%-14.(%l,%c%V%)\ %p%%  " Right aligned file nav info
    set statusline+=%{fugitive#statusline()} " Git Hotness
endif "}}}

" Manage plugins using vim-plug, auto load for first time uses {{{
if empty(glob('~/.vim/autoload/plug.vim'))
    silent !curl -fLo ~/.vim/autoload/plug.vim --create-dirs
                \ https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    autocmd VimEnter * PlugInstall --sync | source $MYVIMRC
endif

call plug#begin('~/.vim/plugged')

Plug 'fatih/vim-go', {'tag': '*'}
Plug 'tpope/vim-commentary'
" Plug 'easymotion/vim-easymotion'
" Plug 'rakr/vim-one'
" Plug 'vim-airline/vim-airline'
" Plug 'vim-airline/vim-airline-themes'
" Plug 'mengelbrecht/lightline-bufferline'
" Plug 'ap/vim-buftabline' " simpler and maybe more useful for me
Plug 'junegunn/fzf', { 'do': { -> fzf#install() } }
Plug 'junegunn/fzf.vim'
Plug 'tpope/vim-fugitive' 
Plug 'tpope/vim-surround'
Plug 'gcmt/wildfire.vim'
Plug 'voldikss/vim-floaterm'
" Plug 'itchyny/lightline.vim'
Plug 'morhetz/gruvbox'
Plug 'NLKNguyen/papercolor-theme'
Plug 'preservim/nerdtree'
" Plug 'airblade/vim-gitgutter'
" Plug 'terryma/vim-multiple-cursors' " Deprecated
Plug 'mg979/vim-visual-multi'
Plug 'iamcco/markdown-preview.nvim', {'do': { -> mkdp#util#install() }, 'for': ['markdown', 'vim-plug']}
if has('nvim')
    " Use release branch (recommend)
    Plug 'neoclide/coc.nvim', {'branch': 'release'}
    " Plug 'lukas-reineke/indent-blankline.nvim'

    " " Or build from source code by using yarn: https://yarnpkg.com
    " Plug 'neoclide/coc.nvim', {'branch': 'master', 'do': 'yarn install  --frozen-lockfile'}
else 
    Plug 'ycm-core/YouCompleteMe'
    " YCM related 
    nmap <leader>yfs <Plug>(YCMFindSymbolInWorkspace)

    augroup YCM
        autocmd!
        autocmd BufWinEnter *.py,*.cpp  {
                nnoremap <buffer> gd :YcmCompleter GoToDefinition<CR>
                nnoremap <buffer> gr :YcmCompleter GoToReferences<CR>
                nnoremap <buffer> gi :YcmCompleter GoToImplementation<CR>
                            } " in neovim/vim8, a leading '\' is needed, buf vim9 is just the opposite.
    augroup END
endif

call plug#end() "}}}


" A function for default basic emacs/bash-like moving in insert mode {{{
" might be useful when using Chinese input method
function! ToggleEmacsMapping()
    " vim has defined ctrl-u alt-b for similar functionality
    if g:emacs_mapping==1
        echo "emacs_mapping is on, turning it off"
        iunmap <C-f>
        iunmap <C-b>
        iunmap <C-n>
        iunmap <C-p>
        iunmap <C-a>
        iunmap <C-e>
        iunmap <C-k>
        iunmap <A-f>
        let g:emacs_mapping=0
    else
        echo "emacs_mapping is off, turning it on"
        inoremap <C-f> <Right>
        inoremap <C-b> <Left>
        inoremap <C-n> <Down>
        inoremap <C-p> <Up>
        inoremap <C-a> <Home>
        inoremap <C-e> <End>
        inoremap <C-k> <esc>d$a
        inoremap <A-f> <esc>lwi
        let g:emacs_mapping=1
    endif
endfunction
let g:emacs_mapping=0
command! -nargs=0 ToggleEmacs call ToggleEmacsMapping() "}}}

" Auto jump back to the last position when opened {{{
function! ResCur() 
    if line("'\"") <= line("$")
        silent! normal! g`"
        return 1
    endif
endfunction 

augroup resCur
    autocmd!
    autocmd BufWinEnter * call ResCur()
augroup END
" Always switch to the current file directory, now I am using 'autochdir' option
" autocmd BufEnter * if bufname("") !~ "^\[A-Za-z0-9\]*://" | lcd %:p:h | endif "}}}

" FZF key Mappings {{{
" for fzf preview-window
" see https://github.com/junegunn/fzf.vim/issues/358
let $FZF_DEFAULT_OPTS="--preview-window 'right:57%' --preview 'bat --style=numbers --line-range :300 {}' --bind ctrl-y:preview-up,ctrl-e:preview-down,ctrl-b:preview-page-up,ctrl-f:preview-page-down,ctrl-u:preview-half-page-up,ctrl-d:preview-half-page-down,shift-up:preview-top,shift-down:preview-bottom,alt-up:half-page-up,alt-down:half-page-down" 

" noremap <C-p> :Files<CR>
noremap <C-p> :PFZF<CR>
noremap <leader>f :PRg<CR>
noremap <leader>t <cmd>FloatermNew<CR>

" borrowed from https://github.com/junegunn/fzf.vim/issues/837
" command! -bang -nargs=* PRg
"   \ call fzf#vim#grep("rg --column --line-number --no-heading --color=always --smart-case ".shellescape(<q-args>), 1, {'dir': expand('%:p:h')}, <bang>0)

command! -bang -nargs=* PRg
  \ call fzf#vim#grep("rg --column --line-number --no-heading --color=always --smart-case ".shellescape(<q-args>), 1, fzf#vim#with_preview({'dir': getenv('PWD')}), <bang>0)

command! -nargs=* -complete=dir -bang PFZF call fzf#run(fzf#wrap('FZF', fzf#vim#with_preview({'dir': getenv('PWD')}), <bang>0))
" source play.vim
"
" copied from https://www.reddit.com/r/vim/comments/gpe3tr/ripgrep_from_inside_vim/
" if executable('rg')
" 	set grepprg=rg\ --vimgrep\ --hidden\ —glob ‘!.git’
" endif
" Then you can just do the following which populates the results in the quick fix list
" :grep <pattern>
" If you want to grep the word under your cursor do
" :grep <c-r><c-w>
" :h c_CTRL-R_CTRL-W to check
"
"}}}

" vim-go navi mappings {{{
autocmd FileType go nnoremap <buffer> gr :GoReferrers<CR>
autocmd FileType go nnoremap <buffer> gi :GoImplements<CR>
autocmd FileType go nnoremap <buffer> goc :GoCallers<CR>
" au filetype go inoremap <buffer> . .<C-x><C-o>

" vim-go settings
let g:go_list_type="quickfix"

"}}}

" markdown-preview config {{{
" set to 1, nvim will open the preview window after entering the markdown buffer
" default: 0
let g:mkdp_auto_start = 0

" set to 1, the nvim will auto close current preview window when change
" from markdown buffer to another buffer
" default: 1
let g:mkdp_auto_close = 1

" set to 1, the vim will refresh markdown when save the buffer or
" leave from insert mode, default 0 is auto refresh markdown as you edit or
" move the cursor
" default: 0
let g:mkdp_refresh_slow = 0

" set to 1, the MarkdownPreview command can be use for all files,
" by default it can be use in markdown file
" default: 0
let g:mkdp_command_for_global = 0

" set to 1, preview server available to others in your network
" by default, the server listens on localhost (127.0.0.1)
" default: 0
let g:mkdp_open_to_the_world = 0

" use custom IP to open preview page
" useful when you work in remote vim and preview on local browser
" more detail see: https://github.com/iamcco/markdown-preview.nvim/pull/9
" default empty
let g:mkdp_open_ip = ''

" specify browser to open preview page
" for path with space
" valid: `/path/with\ space/xxx`
" invalid: `/path/with\\ space/xxx`
" default: ''
let g:mkdp_browser = ''

" set to 1, echo preview page url in command line when open preview page
" default is 0
let g:mkdp_echo_preview_url = 0

" a custom vim function name to open preview page
" this function will receive url as param
" default is empty
let g:mkdp_browserfunc = ''

" options for markdown render
" mkit: markdown-it options for render
" katex: katex options for math
" uml: markdown-it-plantuml options
" maid: mermaid options
" disable_sync_scroll: if disable sync scroll, default 0
" sync_scroll_type: 'middle', 'top' or 'relative', default value is 'middle'
"   middle: mean the cursor position alway show at the middle of the preview page
"   top: mean the vim top viewport alway show at the top of the preview page
"   relative: mean the cursor position alway show at the relative positon of the preview page
" hide_yaml_meta: if hide yaml metadata, default is 1
" sequence_diagrams: js-sequence-diagrams options
" content_editable: if enable content editable for preview page, default: v:false
" disable_filename: if disable filename header for preview page, default: 0
let g:mkdp_preview_options = {
    \ 'mkit': {},
    \ 'katex': {},
    \ 'uml': {},
    \ 'maid': {},
    \ 'disable_sync_scroll': 0,
    \ 'sync_scroll_type': 'middle',
    \ 'hide_yaml_meta': 1,
    \ 'sequence_diagrams': {},
    \ 'flowchart_diagrams': {},
    \ 'content_editable': v:false,
    \ 'disable_filename': 0,
    \ 'toc': {}
    \ }

" use a custom markdown style must be absolute path
" like '/Users/username/markdown.css' or expand('~/markdown.css')
let g:mkdp_markdown_css = ''

" use a custom highlight style must absolute path
" like '/Users/username/highlight.css' or expand('~/highlight.css')
let g:mkdp_highlight_css = ''

" use a custom port to start server or empty for random
let g:mkdp_port = ''

" preview page title
" ${name} will be replace with the file name
let g:mkdp_page_title = '「${name}」'

" recognized filetypes
" these filetypes will have MarkdownPreview... commands
let g:mkdp_filetypes = ['markdown']

" set default theme (dark or light)
" By default the theme is define according to the preferences of the system
let g:mkdp_theme = 'light'

augroup MarkDown
    autocmd!
    autocmd FileType markdown nnoremap <buffer> <F5> :MarkdownPreview<CR>
augroup END
"}}}

" Memo {{{ 
" == formatoptions
" set formatoptions=croql
"
" == set encoding for chinese input and vim language in chinese
" see http://edyfox.codecarver.org/html/vim_fileencodings_detection.html
" set encoding=utf-8
" set langmenu=zh_CN.UTF-8
" language message zh_CN.UTF-8
" set termencoding=gbk
" set fileencodings=ucs-bom,utf-8,cp936,gb18030,big5,euc-jp,euc-kr,latin1

" == mapleader
" let mapleader="\<space>"

" If the current buffer has never been saved, it will have no name,
" call the file browser to save it, otherwise just save it.
" command -nargs=0 -bar Update if &modified
"                            \|    if empty(bufname('%'))
"                            \|        browse confirm write
"                            \|    else
"                            \|        confirm write
"                            \|    endif
"                            \|endif
" nnoremap <silent> <C-S> :<C-u>Update<CR>
" let s:uname = system("echo -n \"$(uname)\"")
" if !v:shell_error && s:uname == "Darwin" && !has("gui_running")
"     echo "map cmd+s as save"
"     inoremap <D-s> <ESC>:Update<CR>
" endif
" }}}

" grep/make integration related stuff {{{
if !executable('rg')
    set grepprg=grep\ -n\ -r\ $*\ %:p:h\ /dev/null
else
    set grepprg=rg\ --vimgrep\ $*\ %:p:h\ /dev/null
endif
"}}}
